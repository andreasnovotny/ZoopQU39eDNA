---
title: "QU39 Zooplankton Time series"
---


# 0. Prepare environment

Load necessary packages and import functions.

```{r}
# Data import
library(googledrive)
library(readxl)
#library(phyloseq)


# All data format modifications and filtering and plotting
library(tidyverse)
'%!in%' <- function(x,y)!('%in%'(x,y))
source("Code/Functions.R")
library(zoo)

# Statistical tools
library(vegan)

# Specific plotting tools
library(ggpubr)
library(paletteer)
library(viridis)
library(cowplot)
#library(ggnewscale)
source("Code/scales_and_themes.R")

# Make sure tidyverse is the latest loaded package
detach("package:tidyverse", unload=TRUE)
library(tidyverse)
```





# ### DATA PREP. ###

# 1. Sequencing dept and negative controls.

In this section, we have a look at sequenced negative controls for the 18S and the COI libraries, and remove samples that have sequence depth lower than the negative controls.\
Here we also produce statistics for annotation levels and read success.\
\
Plotting sequencing depth and removing low libraries for COI:


```{r}
# Plot ranked sequencing depth with threshold line
All_COI_data %>% 
  seq_depth_plot() +
  theme_cowplot(12) +
  theme(aspect.ratio = 1,
        strip.background =element_blank()) +
  geom_abline(intercept = 10000, linetype = 4)
ggsave("Figure_output/Sequencing_Depth_COI.pdf", width = 7, height = 4.5)


# Filter out libraries under threshold line
Good_COI_data <- All_COI_data %>% 
  group_by(Library_ID) %>%
  filter(Site_ID == "QU39") %>% 
  filter(sum(Abundance)>10000) %>% 
  ungroup()

print("Median COI library size:")
Good_COI_data %>% 
  group_by(Library_ID) %>% 
  summarise(SeqDepth = sum(Abundance)) %>%
  pull(SeqDepth) %>% median

print("Number of final COI libraries:")
Good_COI_data %>% 
  pull(Library_ID) %>% unique %>%  length


#### NOTE: Taxonomic correction of the subgenus Ditrichocorycaeus, not yet accepted.
Good_COI_data <- Good_COI_data %>%
  mutate(Genus = ifelse(Genus == "Ditrichocorycaeus", "Corycaeus", Genus),
         Species = ifelse(Species == "Ditrichocorycaeus anglicus","Corycaeus anglicus", Species))
```


Plotting sequencing depth and removing low libraries for 18S:

```{r}
# Plot ranked sequencing depth
All_18S_data %>% 
  seq_depth_plot() +
  theme_cowplot(12) +
  theme(aspect.ratio = 1,
        strip.background =element_blank()) +
  geom_abline(intercept = 10000, linetype = 4)
ggsave("Figure_output/Sequencing_Depth_18S.pdf" , width = 7, height = 4.5)

# Filter out libraries with low read counts.
Good_18S_data <- All_18S_data %>% 
  group_by(Library_ID) %>% 
  filter(sum(Abundance)>10000) %>% 
  ungroup() 

print("Median 18S library size:")
Good_18S_data %>% 
  group_by(Library_ID) %>%
  filter(Site_ID == "QU39") %>% 
  summarise(SeqDepth = sum(Abundance)) %>%
  pull(SeqDepth) %>%median

print("Number of final 18S libraries:")
Good_18S_data %>% 
  pull(Library_ID) %>% unique %>%  length

#### NOTE: Taxonomic correction of the subgenus Ditrichocorycaeus, not yet accepted.
Good_18S_data <- Good_18S_data %>%
  mutate(Genus = ifelse(Genus == "Ditrichocorycaeus", "Corycaeus", Genus),
         Species = ifelse(Species == "Ditrichocorycaeus anglicus","Corycaeus anglicus", Species))
```
# 2. Taxonomic streamlining and eDNA indexing


This code chunk is to streamline the taxonomy between the COI and trait dataset,
by moving species not present in the trait data (or in the microscopy data) to genus level.
Thus getting a general "Taxa" level.

```{r}
# 1. Create a a Genus / Species list for COI data  
Taxa_COI <- Good_COI_data %>% 
  filter(Abundance > 0) %>%
  group_by(Species, Genus) %>% 
  summarize(Abundance = sum(Abundance)) %>% 
  filter(!grepl("@", Genus)) %>%
  mutate(Level = ifelse(grepl("@", Species), "Genus", "Species")) %>% 
  mutate(Species = ifelse(grepl("@", Species), paste(Genus, "sp.", sep = " "), Species)) %>% 
  select(Genus, Species, Level, Abundance)

# 2. Create a a Genus / Species list for Microscopy data
Taxa_MIC <- df_count_2017 %>%
  filter(Abundance > 0) %>%
  group_by(Genus, Tax1) %>% 
  summarise(Abundance = sum(Abundance)) %>% 
  mutate(Species = ifelse(Tax1 == "*sp.", paste(Genus, "sp.", sep = " "), paste(Genus, Tax1, sep = " "))) %>%
  mutate(Level = ifelse(Tax1 == "*sp.", "Genus", "Species")) %>% 
  select

# 3. Read in Trait dataset
trait_dataset <- read_csv("Data_import/Traits/trait_dataset_level2-2023-09-14.csv")


# 4. Filter the COI species that occurs in microscopy data and in the trait database.
# Get list of common species
Species_COI_MIC_TRAIT <- Taxa_COI %>% 
  filter(Level == "Species",
         Species %in% Taxa_MIC$Species,
         Species %in% trait_dataset$scientificName) %>% 
  pull(Species)
Species_COI_MIC_TRAIT

# 5. Remove the common species from the original COI list. Filter remaining genera common in microscopy, and trait data.
# Get list of common and remaining genus names 
Genus_COI_MIC_TRAIT <- Taxa_COI %>% 
  filter(Species %!in% Species_COI_MIC_TRAIT,
         Genus %in% Taxa_MIC$Genus,
         Genus %in% trait_dataset$scientificName) %>% 
  pull(Genus) %>% unique()

# List of valid species
Species_COI_MIC_TRAIT

# List of valid genera
Genus_COI_MIC_TRAIT
```

Filter COI dataset based on Genus and species list

```{r}
# 6. Filter all COI data, for only valid species.
tmp_sp <- Good_COI_data %>% 
  filter(Species %in% Species_COI_MIC_TRAIT) %>% 
  mutate(Taxa = Species)

# 7. Filter remaining COI data for valid genera
tmp_genus <- Good_COI_data %>% 
  filter(Species %!in% Species_COI_MIC_TRAIT,
         Genus %in% Genus_COI_MIC_TRAIT) %>% 
  mutate(Taxa = Genus)

# 8. Merge datasets, summarize by sample and taxonomic level and
# Calculate eDNA-index

eDNA_COI_indexed <- bind_rows(tmp_sp, tmp_genus) %>%
  filter(is.na(Abundance) == FALSE) %>% 
  group_by(Library_ID, Hakai_ID, Line_out_depth, Sample_date, Project_name, Taxa) %>% 
  summarize(Abundance = sum(Abundance)) %>%
  filter(Project_name == "QU39",
         year(Sample_date) %in% c(2017, 2018, 2019)) %>% 
  index_RA(Hakai_ID, Taxa, Abundance, Line_out_depth, Sample_date)
```


Filter Microscopy dataset based on Genus and species list
```{r}
# Repeat step 6-7 but for microscopy data, to get biomass scaling for the same taxonomic levels.

tmp_sp <- df_count_2017 %>% 
  mutate(Species = str_squish(paste(Genus, Tax1, by = ""))) %>%
  filter(Species %in% Species_COI_MIC_TRAIT) %>%
  mutate(Taxa = Species)

tmp_genus <- df_count_2017 %>% 
  mutate(Species = str_squish(paste(Genus, Tax1, by = ""))) %>%
  filter(Species %!in% Species_COI_MIC_TRAIT,
         Genus %in% Genus_COI_MIC_TRAIT) %>%
  mutate(Taxa = Genus)

Biomass_sum <-bind_rows(tmp_sp, tmp_genus) %>%
  filter(is.na(Abundance) == FALSE) %>% 
  group_by(Taxa) %>% 
  summarize(Biomass = round(sum(Abundance))) %>%
  arrange(-Biomass)
```

Compare biomass and sequence abundance
```{r}
eDNA_COI_indexed %>%
  group_by(Taxa) %>% 
  summarise(Seq_Abundance = sum(Abundance)) %>% 
  left_join(Biomass_sum) %>% 
  arrange(-Biomass)
```

Filter Trait dataset based on listls:

```{r}
Trait_filt <- trait_dataset %>% 
  filter(scientificName %in% eDNA_COI_indexed$Taxa) %>% 
  mutate(Taxa = scientificName)

Trait_filt %>% 
  filter(valueType == "binary") %>% 
  group_by(Taxa, traitName) %>% 
  summarise(traitValue) %>% 
  pivot_wider(names_from = "traitName", values_from = "traitValue")


Trait_filt %>% 
  filter(valueType == "categorical") %>% 
  group_by(Taxa, traitName) %>% 
  summarise(Value = paste(traitValue, sep = " "))


Trait_filt %>% 
  pull(valueType) %>% unique
  select(1:3)
  
  
  group_by(valueType) %>% summarise()
```



# 3. Environmental Data components

This is the list of Hakai_ID's we have COI data for: 
```{r}
samples_COI <-  eDNA_COI_index_species %>% 
  pull(Hakai_ID) %>% 
  unique()

samples_COI
```

Extract Hakai Microbial metadata for samples
```{r}
QMIC <- read_excel("./Data_import/2024-02-09_170138_HakaiData_microbial.xlsx",
                   sheet = "Hakai Data") %>% 
  filter(hakai_id %in% samples_COI) %>% 
  arrange(event_pk)

QMIC

niskin <- QMIC %>% 
  mutate(NISKIN = paste(event_pk, line_out_depth, sep = "_")) %>% 
  select(hakai_id,date, line_out_depth, NISKIN ) %>% 
  mutate(date = as_date(date))
niskin
```

Chlorophyll bottle data
```{r}
CHL <- read_excel("./Data_import/2023-12-21_112549_HakaiData_chlorophyll_15-20.xlsx", sheet = "Hakai Data") %>% 
  mutate(NISKIN = paste(event_pk, line_out_depth, sep = "_")) %>% 
  filter(NISKIN %in% niskin$NISKIN) %>% 
  #select(NISKIN, filter_type, chla, phaeo) %>%
  group_by(NISKIN, filter_type) %>% 
  summarise(chla = mean(chla),
            phaeo = mean(phaeo)) %>%
  pivot_wider(names_from = filter_type, values_from = c(chla, phaeo))
CHL
```

Nutrient bottle data
```{r}
NUT <- read_excel("./Data_import/2023-12-21_113016_HakaiData_nutrients.xlsx", sheet = "Hakai Data") %>% 
  mutate(NISKIN = paste(event_pk, line_out_depth, sep = "_")) %>% 
  filter(NISKIN %in% niskin$NISKIN) %>% 
  select(NISKIN, no2_no3_um, po4, sio2) %>% 
  group_by(NISKIN) %>% 
  summarise(no2_no3_um = mean(no2_no3_um),
            po4 = mean(po4),
            sio2 = mean(po4))
NUT
```

CTD Bottle data
```{r}
# Identify the correct CTD drops (Can be improved)
drops <- read_excel("./Data_import/CTD.xlsx", sheet = "Drops") %>% 
  mutate(date = as_date(`Start time`)) %>% 
  filter(date %in% niskin$date,
         `Target depth (m)` > 240) %>% 
  group_by(date) %>% 
  summarise(CastPK = min(`Cast PK`))

# Load and modify CTD data, filter by drop.
CTD <- read_excel("./Data_import/CTD.xlsx", sheet = "Data") %>% 
  transmute(CastPK = `Cast PK`,
            Distance_from_station = `Distance from station`,
            Station,
            Time = `Measurement time`,
            Date = as_date(Time), 
            Depth = `Depth (m)`,
            Conductivity = `Conductivity (mS/cm)`,
            Temperature = `Temperature (deg C)`,
            Pressure = `Pressure (dbar)`,
            PAR = `PAR (umol m-2 s-1)`,
            Chlorophyll = `Fluorometry Chlorophyll (ug/L)`,
            Turbidity = `Turbidity (FTU)`,
            O2 = `Dissolved O2 (mL/L)`,
            Salinity = `Salinity (PSU)`) %>% 
  filter(CastPK %in% drops$CastPK)

# Function for extracting depth data.
closest <- function(dat, m) {
  dat %>% 
  group_by(Date) %>% 
  slice(which.min(abs(Depth - m))) %>% 
  mutate(Depth = m)
}

# Extract data for 0, 5, 30, 100 and 260 m.
ctd_bottle <- bind_rows(
  closest(CTD, 0),
  closest(CTD, 5),
  closest(CTD, 30),
  closest(CTD, 100),
  closest(CTD, 260)) %>%
  select(date = Date, line_out_depth = Depth, Temperature, Salinity, PAR, Turbidity, O2)

ctd_bottle

```

Merge all datasets to bottle file:
```{r}
bottle_file <- niskin %>% 
  left_join(CHL, by = "NISKIN") %>% 
  left_join(NUT, by = "NISKIN") %>% 
  left_join(ctd_bottle, by = c("date", "line_out_depth"))

saveRDS(bottle_file, "Data_output/bottle_file.rds")
```




# Summary, filtered datasets:
```{r}
saveRDS(bottle_file, "Data_output/bottle_file.rds")
saveRDS(eDNA_COI_indexed, "Data_output/eDNA_COI_indexed.rds")
saveRDS(Trait_filt, "Data_output/Trait_filt.rds")
```



# ### PLOTS & STATS ###

```{r}
bottle_file <- readRDS("Data_output/bottle_file.rds")
eDNA_COI_indexed <- readRDS("Data_output/eDNA_COI_indexed.rds")
Trait_filt <- readRDS("Data_output/Trait_filt.rds")
```


## eDNA profiles
```{r}
eDNA_COI_interpolated <- eDNA_COI_indexed %>% 
  mutate(Date = as_date(Sample_date),
         Depth = factor(Line_out_depth,
                                 levels = c(260, 100, 30, 5, 0))) %>%
  filter(is.na(Depth) == FALSE) %>%
  group_by(Taxa) %>% 
  group_modify(~interpolate_rollmean(.x, x1 = Date, x2 = Depth, y = RA_Index,
                                     x1res = 1, x2res = 1, k = 14,
                                     dim = 1))

```


```{r}
# Plot dataset
eDNA_COI_interpolated %>%
  #filter(Taxa == "Acartia") %>% 
  ggplot() +
  geom_raster(aes(Date, Depth, fill = RA_Index)) +
  geom_vline(xintercept = datebreaks, color = "#F5F5F5", size = 0.2, alpha = 0.8) +
  geom_vline(xintercept = yearbreaks, color = "grey", size = 0.2, alpha = 0.8) +
  facet_wrap("Taxa", ncol = 4) +
  #scale_y_reverse() +
  scale_x_date(date_labels="%b %y", breaks  = datebreaks) +
  #scale_fill_viridis(option = "H") +
  scale_fill_gradient2(high = '#4daf4a',
                       low = "white") +
  theme_minimal_vgrid(font_size = 8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.text = element_text(face = "italic"),
        panel.background = element_rect(fill = '#F5F5F5', colour = 'darkgrey'),
        #legend.position="none",,
        aspect.ratio = 1/4)


ggsave("./Figure_output/COI_Interpolation.pdf")

```

### UNTIL HERE WEDNESDAY 2024-10-02




For pressentation purposes: 
```{r}
# Plot dataset
Interp_Species %>%
  filter(Taxa %in% c(
    "Acartia longiremis",
    "Metridia pacifica",
    "Pseudocalanus minutus"
  )) %>% 
  mutate(Depth = factor(Depth, levels = c(
    250, 100, 30, 5, 0
  ))) %>% 
  ggplot() +
  geom_raster(aes(Date, Depth, fill = RA_Index)) +
  geom_vline(xintercept = datebreaks, color = "#F5F5F5", size = 0.2, alpha = 0.8) +
  geom_vline(xintercept = yearbreaks, color = "grey", size = 0.2, alpha = 0.8) +
  facet_wrap("Taxa", ncol = 1) +
  #scale_y_reverse() +
  scale_x_date(date_labels="%b %y", breaks  = datebreaks) +
  #scale_fill_viridis(option = "H") +
  scale_fill_gradient2(high = '#4daf4a',
                       low = "white") +
  theme_minimal_vgrid(font_size = 15) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.text = element_text(face = "italic"),
        panel.background = element_rect(fill = '#F5F5F5', colour = 'darkgrey'),
        #legend.position="none",,
        aspect.ratio = 1/6)
  
ggsave("./Figure_output/COI_depth_pres.pdf", width = 10, height = 7)
```






Plot lines instead

```{r}
Interp_Species %>%
  filter(Taxa %in% "Acartia longiremis") %>% 
  mutate(Depth = factor(Depth)) %>%
  ggplot() +
  geom_line(aes(Date, RA_Index, color = Depth)) +
  facet_wrap("Taxa", scales = "free", ncol = 2) +
  scale_x_date(date_labels="%b %y", breaks  = datebreaks) +
  theme_minimal_vgrid(font_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        #strip.text = element_text(face = "italic"),
        panel.background = element_rect(fill = '#F5F5F5', colour = 'darkgrey'),
        #legend.position="none",,
        aspect.ratio = 1/4) +
  scale_color_manual(values = depth_colors)
  
  ggsave("./Figure_output/COI_Interpolation_acartia.pdf")
  

```
18S

```{r}

# Make species interpolation:
Interp_genus <- S18S_genus %>%
  filter(Taxa %in% c("Paracalanus", "Centropages")) %>%
  group_by(Taxa) %>%
  group_modify(~interpolate_rollmean(.x, x1 = Date, x2 = Depth, y = RA_Index,
                                     # res 
                                     x1res = 1, x2res = 1, k = 14,
                                     dim = 1))



Interp_genus %>%
  filter(Taxa %in% Abundant_18S_genus) %>% 
  mutate(Depth = factor(Depth)) %>%
  ggplot() +
  geom_line(aes(Date, RA_Index, color = Depth)) +
  facet_wrap("Taxa", scales = "free", ncol = 1) +
  scale_x_date(date_labels="%b %y", breaks  = datebreaks) +
  theme_minimal_vgrid(font_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        strip.text = element_text(face = "italic"),
        panel.background = element_rect(fill = '#F5F5F5', colour = 'darkgrey'),
        #legend.position="none",,
        aspect.ratio = 1/4) +
  scale_color_manual(values = depth_colors)

ggsave("Figure_output/centropages_paracalanus.pdf")
```



# 2. Environmental Data

## Bottle data:

```{r}
Bottle_File <- bottle_file %>% 
  dplyr::transmute(Hakai_ID = hakai_id,
                   Date = date,
                   Depth = line_out_depth,
                   depth = factor(line_out_depth, levels = rev(c("260", "100",
                                                             "30", "5", "0"))),
                   Temperature = Temperature,
                   Salinity = Salinity,
                   PAR = PAR,
                   Turbidity = Turbidity,
                   O2 = O2,
                   `chlA (>20um)` = chla_20um,
                   `chlA (>3um)` = chla_3um,
                   `chlA (>0.7um)` = `chla_GF/F`,
                   `phaeo (>20um)` = phaeo_20um,
                   `phaeo (>20um)` = phaeo_3um,
                   `phaeo (>20um)` = `phaeo_GF/F`,
                   `NO2 & NO3` =  no2_no3_um,
                   PO4 = po4
                   ) %>% 
  pivot_longer(5:15, names_to = "Variable", values_to = "value") %>% 
  dplyr::filter(is.na(value) == F) %>% 
  dplyr::mutate(Variable = factor(Variable, levels = c(
    "Temperature", "Salinity",
    "chlA (>20um)", "chlA (>3um)", "chlA (>0.7um)",
    "phaeo (>20um)", "phaeo (>3um)", "phaeo (>0.7um)",
    "NO2 & NO3", "PO4",
    "O2", "PAR", "Turbidity")))
Bottle_File



Bottle_File %>%
  filter(Variable == "chlA (>20um)") %>% 
  ggplot() +
  geom_line(aes(Date, value, color = depth)) +
  facet_wrap("Variable", scales = "free", ncol = 2) +
  scale_x_date(date_labels="%b %y", breaks  = datebreaks) +
  theme_minimal_vgrid(font_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        #strip.text = element_text(face = "italic"),
        panel.background = element_rect(fill = '#F5F5F5', colour = 'darkgrey'),
        #legend.position="none",,
        aspect.ratio = 1/4) +
  scale_color_manual(values = depth_colors)

ggsave("./Figure_output/Bottle_Data.pdf")

```


For pressentation purposes: 
```{r}
Bottle_File %>%
  filter(Variable == "chlA (>20um)") %>% 
  ggplot() +
  geom_line(aes(Date, value, color = depth)) +
  facet_wrap("Variable", scales = "free", ncol = 2) +
  scale_x_date(date_labels="%b %y", breaks  = datebreaks) +
  theme_minimal_vgrid(font_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        #strip.text = element_text(face = "italic"),
        panel.background = element_rect(fill = '#F5F5F5', colour = 'darkgrey'),
        #legend.position="none",,
        aspect.ratio = 1/4) +
  scale_color_manual(values = depth_colors)

  ggsave("./Figure_output/chlA_press.pdf")
```



# 3. Community analysis:

## CCA

```{r}
Abundant_Species <- COI_species %>% 
  group_by(Taxa) %>%
  mutate(maxRA = median(RA)) %>%
  filter(max(RA) >0.1) %>% # 32 species
  pull(Taxa) %>%  unique
Abundant_Species

comm <- COI_species %>% 
  filter(Taxa %in% Abundant_Species) %>% 
  dplyr::group_by(Hakai_ID, Taxa) %>% 
  summarise(Index = mean(RA_Index)) %>%
  pivot_wider(names_from = "Taxa", values_from = "Index") %>% 
  arrange(Hakai_ID) %>% 
  column_to_rownames("Hakai_ID")

env <- bottle_file %>% 
  arrange(hakai_id) %>%
  mutate(Depth = factor(line_out_depth),
         Month = month(date)) %>%
  column_to_rownames("hakai_id")
```

Model filt with stepwise reduction
```{r}
# Model all environmental parameters
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month +
             chla_20um + chla_3um +`chla_GF/F` + `chla_Bulk GF/F` +
             phaeo_20um + phaeo_3um + `phaeo_GF/F` + `phaeo_Bulk GF/F` +
             no2_no3_um + po4,
           data = env,
           na.action = na.omit)
vif.cca(mod)

# Remove po4
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month +
             chla_20um + chla_3um +`chla_GF/F` + `chla_Bulk GF/F` +
             phaeo_20um + phaeo_3um + `phaeo_GF/F` + `phaeo_Bulk GF/F` +
             no2_no3_um,
           data = env,
           na.action = na.omit)
vif.cca(mod)

# Remove chl_20
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month + 
             chla_3um +`chla_GF/F` + `chla_Bulk GF/F` +
             phaeo_20um + phaeo_3um + `phaeo_GF/F` + `phaeo_Bulk GF/F` +
             no2_no3_um,
           data = env,
           na.action = na.omit)
vif.cca(mod)

# Remove phaeo_20
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month + 
             chla_3um +`chla_GF/F` + `chla_Bulk GF/F` +
             phaeo_3um + `phaeo_GF/F` + `phaeo_Bulk GF/F` +
             no2_no3_um,
           data = env,
           na.action = na.omit)
vif.cca(mod)

# chla_GF/F
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month + 
             chla_3um + `chla_Bulk GF/F` +
             phaeo_3um + `phaeo_GF/F` + `phaeo_Bulk GF/F` +
             no2_no3_um,
           data = env,
           na.action = na.omit)
vif.cca(mod)

# Remove `chla_Bulk GF/F` 
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month + 
             chla_3um +
             phaeo_3um + `phaeo_GF/F` + `phaeo_Bulk GF/F` +
             no2_no3_um,
           data = env,
           na.action = na.omit)
vif.cca(mod)

#remove no2_no3_um
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month + 
             chla_3um +
             phaeo_3um + `phaeo_GF/F` + `phaeo_Bulk GF/F`,
           data = env,
           na.action = na.omit)
vif.cca(mod)
plot(mod)

#remove phaeo_3um
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             Depth + Month + 
             chla_3um +
             `phaeo_GF/F` + `phaeo_Bulk GF/F`,
           data = env,
           na.action = na.omit)
vif.cca(mod)
plot(mod)



env
```

Alt 2 only include selected from beginning:


```{r}
# Model all relevant environmental parameters
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             chla_20um + chla_3um +`chla_GF/F` + 
             no2_no3_um + po4,
           data = env,
           na.action = na.omit)
vif.cca(mod)
plot(mod)

# Remove PO4
mod <- cca(comm ~
             Temperature + Salinity + PAR + Turbidity + O2 +
             chla_20um + chla_3um +`chla_GF/F` +
             no2_no3_um,
           data = env,
           na.action = na.omit)
vif.cca(mod)
plot(mod)


```



```{r}
#extracting the data as data frame; env data
veg_1 = as.data.frame(mod$CCA$biplot) %>% 
  rownames_to_column("env")


#extracting the data; genusv
veg_2 = as.data.frame(mod$CCA$v) %>% 
  rownames_to_column("Taxa")

plot <-  ggplot() +
  geom_point(data = veg_2, aes(x = CCA1, y = CCA2), color = "red") +
  #geom_point(data = veg_1, aes(x = CCA1, y = CCA2), color = "blue") +
  ggrepel::geom_text_repel(data = veg_2,
                           aes(x = CCA1, y = CCA2, label = Taxa),
                           nudge_y = -0.05) +

  geom_segment(data = veg_1,
               aes(x = 0, y = 0, xend = CCA1, yend = CCA2),
               arrow = arrow(length = unit(0.25, "cm"))) +
  ggrepel::geom_text_repel(data = veg_1,
                           aes(x = CCA1, y = CCA2, label = env),
                           nudge_y = -0.05,
                           color = "blue",
                           size = 5) +
  theme_bw() +
  theme(axis.text = element_text(size = 16),
        axis.title = element_text(size = 18))
plot

```




## NMDS

```{r}
seasonal_colors = c("#053061", "#3288BD", "#66C2A5", "#7FBC41",
                    "#A6D96A", "#FEE08B", "#FDAE61", "#F46D43",
                    "#D53E4F", "#9E0142", "#67001F", "#40004B")




## WRAPPER
plotNMDS <- function(x) {
  

mat <- COI_species %>%
  filter(Depth == x) %>% 
  dplyr::select(Library_ID, Taxa, RA_Index) %>% 
  pivot_wider(names_from = Taxa, values_from = RA_Index) %>% 
  column_to_rownames("Library_ID") %>% 
  as.matrix()
  
  mat
  
mod <- metaMDS(mat, trymax = 20)

# Extract NMDS data
{  Samples <- 
    scores(mod)$sites %>% 
    as.data.frame() %>%
    rownames_to_column("Library_ID") %>% 
    mutate(Layer = "Samples")
  
  Taxa <-
    scores(mod)$species %>% 
    as.data.frame() %>%
    rownames_to_column("Taxa") %>% 
    mutate(Layer = "Taxa")
  
  NMDS_res <- bind_rows(Samples, Taxa) %>% 
    pivot_wider(names_from = Layer,
              values_from = c(NMDS1, NMDS2))
}

# Merge with metadata
COI_species %>% 
  dplyr::select(Date, Depth, Library_ID) %>%
  mutate(Month = format(as.Date(Date), format="%m"),
         Depth = factor(Depth)) %>%
  left_join(NMDS_res, by = "Library_ID") %>% 
  ggplot(aes(NMDS1_Samples, NMDS2_Samples)) +
  geom_text(aes(NMDS1_Taxa, NMDS2_Taxa, label = Taxa),
            size = 3, colour = "grey", fontface = "italic") +
  geom_point(aes(color = Month, shape = Depth), size = 3) +
  scale_color_manual(values = seasonal_colors)


}

plotNMDS(0)
plotNMDS(5)
plotNMDS(30)
plotNMDS(100)
plotNMDS(250)


```












